name: flow-next-tui

on:
  push:
    branches: [main]
    paths:
      - "flow-next-tui/**"
      - ".github/workflows/publish-tui.yml"
  workflow_dispatch:
    inputs:
      publish:
        description: "Force publish even if version unchanged"
        required: false
        default: false
        type: boolean

defaults:
  run:
    working-directory: flow-next-tui

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint:check

      - name: Test
        run: bun test

  pack-test:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Pack
        run: npm pack

      - name: Test packed tarball
        run: |
          npm install -g ./gmickel-flow-next-tui-*.tgz
          flow-next-tui --version
          flow-next-tui --help
          fntui --help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: flow-next-tui/gmickel-flow-next-tui-*.tgz

  publish:
    needs: pack-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for npm OIDC trusted publishing

    steps:
      - uses: actions/checkout@v4

      - name: Check version change
        id: version
        run: |
          LOCAL=$(jq -r .version package.json)
          NPM=$(npm view @gmickel/flow-next-tui version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "npm=$NPM" >> $GITHUB_OUTPUT
          if [ "$LOCAL" != "$NPM" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed: $NPM -> $LOCAL"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $LOCAL"
          fi

      - name: Setup Node.js
        if: steps.version.outputs.changed == 'true' || inputs.publish == true
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Setup Bun
        if: steps.version.outputs.changed == 'true' || inputs.publish == true
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.version.outputs.changed == 'true' || inputs.publish == true
        run: bun install --frozen-lockfile

      - name: Publish to npm
        if: steps.version.outputs.changed == 'true' || inputs.publish == true
        run: npm publish --provenance --access public
        # No NPM_TOKEN needed - uses OIDC trusted publishing
